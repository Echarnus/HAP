# HAP - Deployment Workflow
# Deploys Home Assistant configuration to Raspberry Pi via SSH
# Triggered on push to main branch after validation passes

name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main
    paths:
      - 'src/config/**'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      restart_ha:
        description: 'Restart Home Assistant after deploy'
        required: true
        default: 'true'
        type: boolean

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-to-pi
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Before Deploy
    uses: ./.github/workflows/validate.yml

  deploy:
    name: Deploy Configuration
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Sync configuration to Pi
        run: |
          echo "Deploying configuration to Raspberry Pi..."

          # Sync config files (excluding secrets and local dev files)
          rsync -avz --delete \
            --exclude 'secrets.yaml' \
            --exclude 'secrets.yaml.local' \
            --exclude '*.example' \
            --exclude '.git*' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            src/config/ \
            ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/config/

          echo "Configuration synced successfully"

      - name: Sync Python scripts
        run: |
          echo "Syncing Python scripts..."

          # Create scripts directory if it doesn't exist
          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} "mkdir -p /config/scripts"

          # Sync scripts
          rsync -avz \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            src/scripts/ \
            ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/config/scripts/

          echo "Scripts synced successfully"

      - name: Validate configuration on Pi
        run: |
          echo "Validating configuration on Raspberry Pi..."

          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
            "ha core check" || {
              echo "Configuration validation failed on Pi!"
              exit 1
            }

          echo "Configuration validated on Pi"

      - name: Restart Home Assistant
        if: ${{ github.event.inputs.restart_ha != 'false' }}
        run: |
          echo "Restarting Home Assistant..."

          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
            "ha core restart"

          echo "Home Assistant restart initiated"

      - name: Wait for Home Assistant
        if: ${{ github.event.inputs.restart_ha != 'false' }}
        run: |
          echo "Waiting for Home Assistant to become available..."

          # Wait up to 5 minutes for HA to restart
          for i in {1..30}; do
            if ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
              "curl -sf http://localhost:8123/api/" > /dev/null 2>&1; then
              echo "Home Assistant is up and running!"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done

          echo "WARNING: Home Assistant did not become available within timeout"
          exit 1

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ secrets.PI_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration deployed successfully!" >> $GITHUB_STEP_SUMMARY
